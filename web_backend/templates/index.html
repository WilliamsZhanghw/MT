<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MT4 Web Dashboard</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #131722; color: #d1d4dc; display: flex; flex-direction: column; align-items: center; padding: 1rem; }
        .dashboard { display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; width: 100%; max-width: 1400px; }
        .chart-container { display: flex; flex-direction: column; background: #1e222d; border-radius: 8px; padding: 1rem; }
        .controls-container { display: flex; flex-direction: column; gap: 1rem; }
        .widget { background: #1e222d; border-radius: 8px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 0.5rem; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 0.5rem; font-weight: 500; color: #aaa; }
        input, select { padding: 0.75rem; border: 1px solid #444; background-color: #333; color: #eee; border-radius: 4px; font-size: 1rem; }
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem; }
        button { padding: 0.8rem; border: none; border-radius: 4px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: opacity 0.2s; color: white; }
        .buy-btn { background-color: #26a69a; }
        .sell-btn { background-color: #ef5350; }
        .alert-btn { background-color: #5c6bc0; grid-column: span 2; margin-top: 0.5rem; }
        #logs { margin-top: 1rem; background-color: #131722; border: 1px solid #444; padding: 1rem; border-radius: 4px; height: 250px; overflow-y: auto; font-family: "Courier New", monospace; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="chart-container">
            <h2 id="chart-title">Real-Time Price Chart</h2>
            <div id="chart" style="width: 100%; height: 500px;"></div>
        </div>
        <div class="controls-container">
            <div class="widget" id="agent-control-widget">
                <h2>Remote Agent Control</h2>
                <div id="agent-list">
                    <p>Waiting for agents to connect...</p>
                </div>
            </div>
            <div class="widget">
                <h2>Trade Control</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="symbol">Symbol</label>
                        <input type="text" id="symbol" value="EURUSD">
                    </div>
                    <div class="form-group">
                        <label for="volume">Volume</label>
                        <input type="text" id="volume" value="0.01">
                    </div>
                    <div class="form-group">
                        <label for="sl">Stop Loss (Price)</label>
                        <input type="text" id="sl" value="0">
                    </div>
                    <div class="form-group">
                        <label for="tp">Take Profit (Price)</label>
                        <input type="text" id="tp" value="0">
                    </div>
                </div>
                <div class="button-group">
                    <button class="buy-btn" onclick="sendTrade('BUY')">BUY</button>
                    <button class="sell-btn" onclick="sendTrade('SELL')">SELL</button>
                </div>
            </div>
            <div class="widget">
                <h2>Price Alert</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="alert-condition">Condition</label>
                        <select id="alert-condition">
                            <option value=">">Price &gt;</option>
                            <option value="<">Price &lt;</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="alert-price">Price Level</label>
                        <input type="text" id="alert-price" placeholder="Enter price">
                    </div>
                </div>
                <button class="alert-btn" onclick="setAlert()">Set Alert</button>
            </div>
        </div>
    </div>
    <div id="logs" style="width: 100%; max-width: 1400px;"></div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const socket = io();
        const logsContainer = document.getElementById('logs');
        const symbolInput = document.getElementById('symbol');
        const chartTitle = document.getElementById('chart-title');
        let currentSubscribedSymbol = '';
        let alertSound = new Audio('https://www.soundjay.com/buttons/sounds/beep-07.mp3');
        const agentListContainer = document.getElementById('agent-list');

        // --- Chart Setup ---
        const chart = LightweightCharts.createChart(document.getElementById('chart'), {
            width: document.getElementById('chart').clientWidth,
            height: 500,
            layout: { backgroundColor: '#1e222d', textColor: '#d1d4dc' },
            grid: { vertLines: { color: '#444' }, horzLines: { color: '#444' } },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            timeScale: { timeVisible: true, secondsVisible: true },
        });
        const candleSeries = chart.addCandlestickSeries({ upColor: '#26a69a', downColor: '#ef5350', borderVisible: false, wickUpColor: '#26a69a', wickDownColor: '#ef5350' });
        let bidLine = candleSeries.createPriceLine({ price: 0.0, color: '#26a69a', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: 'Ask' });
        let askLine = candleSeries.createPriceLine({ price: 0.0, color: '#ef5350', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: 'Bid' });

        // --- Socket.IO Handlers ---
        socket.on('log_message', (msg) => log(msg.data, 'white'));
        socket.on('price_alert', (msg) => {
            log(msg.data, '#5c6bc0');
            alertSound.play();
            alert(`Price Alert Triggered: ${msg.data}`);
        });
        socket.on('tick_data', (tick) => {
            if (tick.symbol === currentSubscribedSymbol) {
                const now = Math.floor(Date.now() / 1000);
                candleSeries.update({ time: now, open: tick.bid, high: tick.ask, low: tick.bid, close: tick.ask });
                bidLine.applyOptions({ price: tick.bid });
                askLine.applyOptions({ price: tick.ask });
            }
        });
        socket.on('update_agents', (agents) => {
            updateAgentControls(agents);
        });

        // --- UI Functions ---
        function log(message, color = 'white') {
            const entry = document.createElement('div');
            entry.style.color = color;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsContainer.appendChild(entry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function sendTrade(tradeType) {
            const data = { type: tradeType, symbol: symbolInput.value, volume: document.getElementById('volume').value, sl: document.getElementById('sl').value, tp: document.getElementById('tp').value };
            if (!data.symbol || parseFloat(data.volume) <= 0) { alert('Symbol and positive Volume are required.'); return; }
            socket.emit('send_trade_command', data);
        }

        function setAlert() {
            const data = { symbol: symbolInput.value, condition: document.getElementById('alert-condition').value, price: document.getElementById('alert-price').value };
            if (!data.symbol || !data.price || parseFloat(data.price) <= 0) { alert('Symbol and a positive Price are required for alerts.'); return; }
            socket.emit('set_alert', data);
        }
        
        function subscribeToSymbol(symbol) {
            if (symbol && symbol !== currentSubscribedSymbol) {
                currentSubscribedSymbol = symbol;
                chartTitle.textContent = `Real-Time Price Chart for ${symbol}`;
                // Clear old chart data
                candleSeries.setData([]);
                socket.emit('subscribe_symbol', { symbol: symbol });
            }
        }
        
        function startProfile(agentName, profileName) {
            if (confirm(`Are you sure you want to switch agent '${agentName}' to profile '${profileName}'? This will restart its MT4 terminal.`)) {
                socket.emit('start_profile_on_agent', { agent: agentName, profile: profileName });
            }
        }

        function updateAgentControls(agents) {
            agentListContainer.innerHTML = ''; // Clear existing controls
            if (agents.length === 0) {
                agentListContainer.innerHTML = '<p>No agents are currently connected.</p>';
                return;
            }

            agents.forEach(agent => {
                const agentDiv = document.createElement('div');
                agentDiv.className = 'agent-control';
                agentDiv.innerHTML = `<h3>${agent.name}</h3>`;

                if (agent.profiles && agent.profiles.length > 0) {
                    const select = document.createElement('select');
                    select.id = `profile-select-${agent.name}`;
                    agent.profiles.forEach(profile => {
                        const option = document.createElement('option');
                        option.value = profile;
                        option.textContent = profile;
                        select.appendChild(option);
                    });
                    agentDiv.appendChild(select);

                    const button = document.createElement('button');
                    button.textContent = 'Switch Profile';
                    button.onclick = () => {
                        const selectedProfile = document.getElementById(`profile-select-${agent.name}`).value;
                        startProfile(agent.name, selectedProfile);
                    };
                    agentDiv.appendChild(button);
                } else {
                    agentDiv.innerHTML += '<p>No profiles reported yet.</p>';
                }
                agentListContainer.appendChild(agentDiv);
            });
        }
        
        // Initial subscription
        window.addEventListener('load', () => subscribeToSymbol(symbolInput.value));
        // Resubscribe on symbol change
        symbolInput.addEventListener('change', () => subscribeToSymbol(symbolInput.value));

    </script>
</body>
</html>
